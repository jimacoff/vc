import React from 'react';
import inflection from 'inflection';
import {extend, ffetch, storageKey, buildQuery, flattenFilters} from '../global/utils';
import {
  CompetitorIndustriesOptions,
  CompetitorFundTypesOptions,
  CompetitorsLocationsPath,
  CompaniesSearchPath,
} from '../global/constants.js.erb';
import Select from '../global/fields/select';
import Company from './company';
import {Button, Column, Row, Colors} from 'react-foundation';
import Highlighter from 'react-highlight-words';

const SessionStorageKey = storageKey('Filters');

export default class Filters extends React.Component {
  static defaultProps = {
    showButton: true,
    showLabels: false,
    onChange: _.noop,
    onButtonClick: _.noop,
  };

  constructor(props) {
    super(props);

    this.state = {
      numInvestors: this.props.initialCount,
      filters: this.props.initialFilters || JSON.parse(sessionStorage.getItem(SessionStorageKey)) || {},
      inputs: {},
    };
  }

  componentDidMount() {
    if (!this.state.numInvestors) {
      this.fetchNumInvestors(this.state.filters);
    }
  }

  componentDidUpdate(prevProps, prevState) {
    if (buildQuery(this.props.countSource.query) !== buildQuery(prevProps.countSource.query)) {
      this.fetchNumInvestors(this.state.filters);
    }
  }

  fetchNumInvestors(filters) {
    const {path, query} = this.props.countSource;
    let flattened = flattenFilters(filters);
    let built = buildQuery({...query, ...flattened});
    if (built) {
      ffetch(`${path}?${built}`).then(({count}) => {
        this.setState({numInvestors: count});
        this.props.onChange(flattened, count);
      });
    } else {
      ffetch(path).then(({count}) => {
        this.setState({numInvestors: null});
        this.props.onChange({}, count);
      });
    }
  }

  onInputChange = (name, val) => {
    let inputs = extend(this.state.inputs, {[name]: val});
    this.setState({inputs});
  };

  onChange = (update) => {
    let filters = extend(this.state.filters, update);
    sessionStorage.setItem(SessionStorageKey, JSON.stringify(filters));
    this.setState({filters});
    this.fetchNumInvestors(filters);
  };

  selectProps(name, label) {
    let optionRenderer = o => <Highlighter
      highlightClassName='highlighter'
      searchWords={[this.state.inputs[name]]}
      textToHighlight={o.label}
    />;
    return {
      name: name,
      value: this.state.filters[name],
      placeholder: label,
      multi: true,
      optionRenderer,
      onInputChange: v => this.onInputChange(name, v),
      onChange: this.onChange,
    };
  }

  renderSelectWithProps(size, label, props) {
    let select = <Select {...props} />;
    if (this.props.showLabels) {
      select = (
        <label>
          <h6>{label}</h6>
          {select}
        </label>
      );
    }
    return (
      <Column large={size} className="filter-column">
        {select}
      </Column>
    );
  }

  renderSelect(name, label, options, size = 3) {
    return this.renderSelectWithProps(size, label, {options, ...this.selectProps(name, label)});
  }

  renderStaticRemoteSelect(name, label, path, size = 3) {
    let loadOptions = () => ffetch(path).then(options => ({options, complete: true}));
    let searchPromptText = "No results found";
    return this.renderSelectWithProps(size, label, {loadOptions, searchPromptText, ...this.selectProps(name, label)});
  }

  renderDynamicRemoteSelect(name, label, path, size = 3, OptionComponent = null) {
    let loadOptions = (q) => {
      if (!q) {
        return ffetch(`${path}`).then(options => ({options: (this.state.filters[name] || []).concat(options)}));
      } else {
        return ffetch(`${path}?${buildQuery({q})}`).then(options => ({options}));
      }
    };
    let props = this.selectProps(name, label);
    if (OptionComponent) {
      props.optionRenderer = o => <OptionComponent input={this.state.inputs[name]} {...o} />;
    }
    return this.renderSelectWithProps(size, label, {loadOptions, ...props});
  }

  numInvestors() {
    if (!this.state.numInvestors) {
      return null;
    }

    return this.state.numInvestors;
  }

  renderButton() {
    return (
      <Column large={2} className="filter-column">
        <div className="boxed">
          <Button color={Colors.SUCCESS} onClick={this.props.onButtonClick}>
            Find {this.numInvestors()} {inflection.inflect('Investors', this.state.numInvestors)}
          </Button>
        </div>
      </Column>
    );
  }

  render() {
    let { showButton } = this.props;
    return (
      <div className="filters">
        <Row>
          {this.renderSelect('fund_type', 'Stage', CompetitorFundTypesOptions, 2)}
          {this.renderSelect('industry', 'Industries', CompetitorIndustriesOptions, 2)}
          {this.renderDynamicRemoteSelect('location', 'Cities', CompetitorsLocationsPath, showButton ? 3 : 4)}
          {this.renderDynamicRemoteSelect('companies', 'Invested In', CompaniesSearchPath, showButton ? 3 : 4, Company)}
          {showButton ? this.renderButton() : null}
        </Row>
      </div>
    );
  }
}